<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <link href="style.css" rel="stylesheet">
</head>

<body>
    <!-- Notification Element -->
    <div id="notification" class="notification"></div>
  
    <div class="container">
        <!--Sidebar-->
        <div class="sidebar">
            <div class="logo">
                <i class="fas fa-graduation-cap"></i>
                EduManager
            </div>
            <div class="nav-item active" data-section="dashboard">
                <i class="fas fa-chart-pie"></i>
                Dashboard
            </div>
            <div class="nav-item" data-section="students">
                <i class="fas fa-users"></i>
                Students
            </div>
            <div class="nav-item" data-section="classes">
                <i class="fas fa-book"></i>
                Courses
            </div>
            <div class="nav-item" data-section="teachers">
                <i class="fas fa-chalkboard-teacher"></i>
                Reports
            </div>
            <div class="nav-item" data-section="settings">
                <i class="fas fa-cog"></i>
                Settings
            </div>
        </div>
        <!--Main content-->
        <div class="main-content">
            <div class="header">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search...">
                </div>
                <div class="user-profile">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <span>Admin</span>
                </div>
            </div>

            <!--Dashboard section-->
            <div id="dashboardSection" class="section dashboard active">
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="card-title">Total Students</div>
                        <div class="card-value">0</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-book"></i>
                            </div>
                        </div>
                        <div class="card-title">Active Courses</div>
                        <div class="card-value">0</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-graduation-cap"></i>
                            </div>
                        </div>
                        <div class="card-title">Total Graduates</div>
                        <div class="card-value">0</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                        <div class="card-title">Success Rate</div>
                        <div class="card-value">0%</div>
                    </div>
                </div>

                <div class="student-list">
                    <div class="table-header">
                        <h2>Recent Students</h2>
                        <button class="add-student-btn" onclick="openStudentModal()">
                            <i class="fas fa-plus"></i>
                            Add Student
                        </button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Name</th>
                                <th>Course</th>
                                <th>Enrollment Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody">
                            <!--Recent students go here-->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Full Students Section -->
            <div id="student-section" class="section">
                <div class="student-list">
                    <div class="table-header">
                        <h2>All Students</h2>
                        <button class="add-student-btn" onclick="openStudentModal()">
                            <i class="fas fa-plus"></i>
                            Add Student
                        </button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Name</th>
                                <th>Course</th>
                                <th>Enrollment Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="allStudentTableBody">
                            <!--All students go here-->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Courses Section -->
            <div id="courses-section" class="section">
                <div class="course-list">
                    <div class="table-header">
                        <h2>Course List</h2>
                        <button class="add-course-btn" onclick="openCourseModal()">
                            <i class="fas fa-plus"></i>
                            Add Course
                        </button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Course ID</th>
                                <th>Course Name</th>
                                <th>Course Description</th>
                                <th>Course Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="allCoursesTableBody">
                            <!--Courses go here-->
                        </tbody>
                    </table>
                </div>
            </div>

            <!--Reports Section-->
            <div id="reports-section" class="section">
                <h2>Reports Coming Soon</h2>
            </div>

            <!--Settings Coming Section-->
            <div id="settings-section" class="section">
                <h2>Settings Coming Soon</h2>
            </div>
        </div>
    </div>

    <!--Student Modal-->
    <div class="model" id="studentModel">
        <div class="model-content">
            <div class="model-header">
                <h2 id="studentModelTitle">Add New Student</h2>
                <button class="close-btn" onclick="closeStudentModal()">&times;</button>
            </div>
            <form id="studentForm">
                <div class="form-group">
                    <label for="studentName">Student Name:</label>
                    <input type="text" id="studentName" name="studentName" required>
                </div>
                <div class="form-group">
                    <label for="studentEmail">Student Email:</label>
                    <input type="email" id="studentEmail" name="studentEmail" required>
                </div>
                <div class="form-group">
                    <label for="course">Course</label>
                    <select id="course" name="course" required>
                        <option value="">Select a course</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="enrollmentDate">Enrollment Date</label>
                    <input type="date" id="enrollmentDate" name="enrollmentDate" required />
                </div>
                <button type="submit" class="submit-btn">Save Student</button>
            </form>
        </div>
    </div>

    <!--Delete confirmation modal-->
    <div class="model" id="deleteModel">
        <div class="model-content">
            <div class="model-header">
                <h2>Confirm Deletion</h2>
                <button class="close-btn" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div style="margin: 20px 0">
                <p>Are you sure you want to delete this record? This action cannot be undone.</p>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end">
                <button class="action-btn" onclick="closeDeleteModal()" style="padding: 8px 16px;">Cancel</button>
                <button class="action-btn delete-btn" onclick="confirmDelete()" style="padding: 8px 16px;">Delete</button>
            </div>
        </div>
    </div>

    <!--Course Modal-->
    <div class="model" id="courseModel">
        <div class="model-content">
            <div class="model-header">
                <h2 id="courseModelTitle">Add New Course</h2>
                <button class="close-btn" onclick="closeCourseModal()">&times;</button>
            </div>
            <form id="courseForm">
                <div class="form-group">
                    <label for="courseName">Course Name:</label>
                    <input type="text" id="courseName" name="courseName" required>
                </div>
                <div class="form-group">
                    <label for="courseDescription">Course Description:</label>
                    <textarea id="courseDescription" name="courseDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label for="courseDuration">Duration (months)</label>
                    <input type="number" id="courseDuration" name="courseDuration" required>
                </div>
                <div class="form-group">
                    <label for="courseStatus">Status</label>
                    <select id="courseStatus" name="courseStatus" required>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <button type="submit" class="submit-btn">Save Course</button>
            </form>
        </div>
    </div>

    <!--loading Spinner-->
    <div class="loading-spinner">
        <div class="spinner"></div>
    </div>

    <script>
/* ====== Config & State ====== */
const API_BASE_URL = 'http://localhost:8080';

let students = [];
let courses = [];
let currentSection = 'dashboard';
let editingId = null;
let editingCourseId = null;
let deleteType = null;
let deleteId = null;
let isLoading = false; // Add loading state

/* ====== DOM Refs ====== */
const studentTableBody = document.getElementById('studentTableBody');
const allStudentTableBody = document.getElementById('allStudentTableBody');
const courseTableBody = document.getElementById('allCoursesTableBody');

const studentModel = document.getElementById('studentModel');
const courseModel = document.getElementById('courseModel');
const deleteConfirmationModal = document.getElementById('deleteModel');

const studentForm = document.getElementById('studentForm');
const courseForm = document.getElementById('courseForm');

const searchInput = document.querySelector('.search-bar input');
const loadingSpinner = document.querySelector('.loading-spinner');
const notificationElement = document.getElementById('notification');

/* Section Mapping */
const sectionNameMap = {
  dashboard: 'dashboard',
  students: 'students',
  classes: 'courses',
  teachers: 'reports',
  settings: 'settings'
};

const sectionIdMap = {
  dashboard: 'dashboardSection',
  students: 'student-section',
  courses: 'courses-section',
  reports: 'reports-section',
  settings: 'settings-section',
};

/* ====== Init ====== */
document.addEventListener('DOMContentLoaded', async () => {
  initializeEventListeners();
  await checkAndLoadData();
});

function initializeEventListeners() {
  if (studentForm) studentForm.addEventListener('submit', handleStudentFormSubmit);
  if (courseForm) courseForm.addEventListener('submit', handleCourseFormSubmit);
  if (searchInput) searchInput.addEventListener('input', handleSearch);

  document.querySelectorAll('.nav-item').forEach((item) => {
    item.addEventListener('click', async () => {
      const raw = item.dataset.section;
      const normalized = sectionNameMap[raw] || 'dashboard';
      await handleNavigation(normalized);
    });
  });

  window.addEventListener('click', (event) => {
    if (event.target === studentModel) closeStudentModal();
    if (event.target === courseModel) closeCourseModal();
    if (event.target === deleteConfirmationModal) closeDeleteModal();
  });
}

/* ====== Navigation Handler ====== */
async function handleNavigation(sectionName) {
  // Update UI first
  navigateToSection(sectionName);
  
  // Then load appropriate data
  if (sectionName === 'courses') {
    await loadCourses();
  } else if (sectionName === 'students' || sectionName === 'dashboard') {
    await loadStudents();
    if (sectionName === 'dashboard') {
      await updateDashboardStats();
    }
  }
}

function navigateToSection(sectionName) {
  currentSection = sectionName;

  document.querySelectorAll('.nav-item').forEach((item) => {
    const raw = item.dataset.section;
    const normalized = sectionNameMap[raw] || raw;
    item.classList.toggle('active', normalized === sectionName);
  });

  document.querySelectorAll('.section').forEach((sec) => {
    sec.classList.remove('active');
  });

  const targetId = sectionIdMap[sectionName];
  const target = targetId ? document.getElementById(targetId) : null;
  if (target) target.classList.add('active');
}

/* ====== Data Loading ====== */
async function checkAndLoadData() {
  if (isLoading) return;
  isLoading = true;
  showLoading();
  
  try {
    await loadCourses();

    if (courses.length === 0) {
      showNotification('Please add courses before managing students', 'warning');
      navigateToSection('courses');
      openCourseModal();
      return;
    }

    await loadStudents();
    await updateDashboardStats();
  } catch (error) {
    console.error('Error during initialization', error);
    showNotification('Error during initialization', 'error');
  } finally {
    hideLoading();
    isLoading = false;
  }
}

async function loadCourses() {
  if (isLoading) return;
  isLoading = true;
  showLoading();
  
  try {
    console.log('Loading courses...'); // Debug log
    const response = await fetch(`${API_BASE_URL}/api/courses`);
    if (!response.ok) throw new Error('Error fetching courses');

    courses = await response.json();
    updateCourseDropdown(courses);
    renderCourseTable(courses);
    return courses;
  } catch (error) {
    console.error('Error fetching courses', error);
    showNotification('Error fetching courses', 'error');
    courses = [];
    renderCourseTable([]);
  } finally {
    hideLoading();
    isLoading = false;
  }
}

async function loadStudents() {
  if (isLoading) return;
  isLoading = true;
  showLoading();
  
  try {
    console.log('Loading students...'); // Debug log
    const response = await fetch(`${API_BASE_URL}/api/students`);
    if (!response.ok) throw new Error('Error fetching students');

    students = await response.json();
    renderStudentTables(students);
  } catch (error) {
    console.error('Error fetching students', error);
    showNotification('Error fetching students', 'error');
    students = [];
    renderStudentTables([]);
  } finally {
    hideLoading();
    isLoading = false;
  }
}

/* ====== Dashboard ====== */
async function updateDashboardStats() {
  if (isLoading) return;
  isLoading = true;
  showLoading();
  
  try {
    console.log('Loading dashboard stats...'); // Debug log
    const response = await fetch(`${API_BASE_URL}/api/dashboard/stats`);
    if (!response.ok) throw new Error('Error fetching dashboard stats');

    const stats = await response.json();
    updateDashboardUI(stats);
  } catch (error) {
    console.error('Error updating dashboard stats', error);
    showNotification('Error updating dashboard stats', 'error');
  } finally {
    hideLoading();
    isLoading = false;
  }
}

function updateDashboardUI(stats) {
  const s1 = document.querySelector('.card:nth-child(1) .card-value');
  const s2 = document.querySelector('.card:nth-child(2) .card-value');
  const s3 = document.querySelector('.card:nth-child(3) .card-value');
  const s4 = document.querySelector('.card:nth-child(4) .card-value');

  if (s1) s1.textContent = (stats.totalStudents ?? 0).toLocaleString();
  if (s2) s2.textContent = (stats.activeCourses ?? 0).toLocaleString();
  if (s3) s3.textContent = (stats.graduates ?? 0).toLocaleString();
  if (s4) s4.textContent = `${stats.successRate ?? 0}%`;
}
/* ====== Student Operations ====== */
async function loadStudents() {
  try {
    const response = await fetch(`${API_BASE_URL}/api/students`);
    if (!response.ok) throw new Error('Error fetching students');

    students = await response.json();
    renderStudentTables(students);
  } catch (error) {
    console.error('Error fetching students', error);
    showNotification('Error fetching students', 'error');
    students = [];
    renderStudentTables([]);
  }
}

async function createStudent(studentData) {
  const response = await fetch(`${API_BASE_URL}/api/students`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(studentData),
  });
  if (!response.ok) {
    const error = await response.json().catch(() => ({}));
    throw new Error(error.message || 'Error creating student');
  }
  return response.json();
}

async function updateStudent(id, studentData) {
  const response = await fetch(`${API_BASE_URL}/api/students/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(studentData),
  });
  if (!response.ok) {
    const error = await response.json().catch(() => ({}));
    throw new Error(error.message || 'Error updating student');
  }
  return response.json();
}

/* ====== Course Operations ====== */
async function loadCourses() {
  try {
    const response = await fetch(`${API_BASE_URL}/api/courses`);
    if (!response.ok) throw new Error('Error fetching courses');

    courses = await response.json();
    updateCourseDropdown(courses);
    renderCourseTable(courses);
    return courses;
  } catch (error) {
    console.error('Error fetching courses', error);
    showNotification('Error fetching courses', 'error');
    courses = [];
    renderCourseTable([]);
  }
}

async function createCourse(courseData) {
  const response = await fetch(`${API_BASE_URL}/api/courses`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(courseData),
  });
  if (!response.ok) {
    const error = await response.json().catch(() => ({}));
    throw new Error(error.message || 'Error creating course');
  }
  return response.json();
}

async function updateCourse(id, courseData) {
  const response = await fetch(`${API_BASE_URL}/api/courses/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(courseData),
  });
  if (!response.ok) {
    const error = await response.json().catch(() => ({}));
    throw new Error(error.message || 'Error updating course');
  }
  return response.json();
}

/* ====== Delete Operations ====== */
function askDeleteStudent(id) {
  deleteType = 'student';
  deleteId = id;
  if (deleteConfirmationModal) deleteConfirmationModal.style.display = 'flex';
}

function askDeleteCourse(id) {
  deleteType = 'course';
  deleteId = id;
  if (deleteConfirmationModal) deleteConfirmationModal.style.display = 'flex';
}

function closeDeleteModal() {
  if (deleteConfirmationModal) deleteConfirmationModal.style.display = 'none';
  deleteType = null;
  deleteId = null;
}

async function confirmDelete() {
  if (!deleteType || !deleteId) return;

  showLoading();
  try {
    if (deleteType === 'student') {
      const response = await fetch(`${API_BASE_URL}/api/students/${deleteId}`, { method: 'DELETE' });
      if (!response.ok) throw new Error('Error deleting student');

      showNotification('Student deleted successfully', 'success');
      await loadStudents();
      await updateDashboardStats();
    } else if (deleteType === 'course') {
      const response = await fetch(`${API_BASE_URL}/api/courses/${deleteId}`, { method: 'DELETE' });
      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        throw new Error(err.message || 'Failed to delete course');
      }
      showNotification('Course deleted successfully', 'success');
      await loadCourses();
      await updateDashboardStats();
    }
  } catch (error) {
    console.error('Error during deletion:', error);
    showNotification(error.message || 'Error deleting record', 'error');
  } finally {
    hideLoading();
    closeDeleteModal();
  }
}

/* ====== Form Handlers ====== */
async function handleStudentFormSubmit(e) {
  e.preventDefault();
  showLoading();

  const studentData = {
    name: (document.getElementById('studentName')?.value || '').trim(),
    email: (document.getElementById('studentEmail')?.value || '').trim(),
    course: document.getElementById('course')?.value || '',
    enrollmentDate: document.getElementById('enrollmentDate')?.value || '',
    status: 'active',
  };

  try {
    if (editingId) {
      await updateStudent(editingId, studentData);
      showNotification('Student updated successfully', 'success');
    } else {
      await createStudent(studentData);
      showNotification('Student created successfully', 'success');
    }
    closeStudentModal();
    await loadStudents();
    await updateDashboardStats();
  } catch (error) {
    console.error('Error during student form submission:', error);
    showNotification(error.message || 'Error saving student', 'error');
  } finally {
    hideLoading();
  }
}

async function handleCourseFormSubmit(e) {
  e.preventDefault();
  showLoading();

  const courseData = {
    name: (document.getElementById('courseName')?.value || '').trim(),
    description: (document.getElementById('courseDescription')?.value || '').trim(),
    duration: parseInt(document.getElementById('courseDuration')?.value || '0', 10),
    status: document.getElementById('courseStatus')?.value || 'inactive',
  };

  try {
    if (editingCourseId) {
      await updateCourse(editingCourseId, courseData);
      showNotification('Course updated successfully', 'success');
    } else {
      await createCourse(courseData);
      showNotification('Course created successfully', 'success');
    }
    closeCourseModal();
    await loadCourses();
    await updateDashboardStats();
  } catch (error) {
    console.error('Error during course form submission:', error);
    showNotification('Error saving course data', 'error');
  } finally {
    hideLoading();
  }
}

/* ====== Rendering ====== */
function renderStudentTables(studentsToRender) {
  renderStudentListIntoTable(studentTableBody, studentsToRender);
  renderStudentListIntoTable(allStudentTableBody, studentsToRender);
}

function renderStudentListIntoTable(tableBody, studentsToRender) {
  if (!tableBody) return;
  tableBody.innerHTML = '';

  if (!studentsToRender || studentsToRender.length === 0) {
    const thCount = tableBody.closest('table')?.querySelectorAll('th')?.length || 6;
    tableBody.innerHTML = `
      <tr>
        <td colspan="${thCount}" class="empty-state">
          <i class="fas fa-users"></i>
          <h3>No students found</h3>
          <p>Click "Add Student" to add your first student</p>
        </td>
      </tr>`;
    return;
  }

  studentsToRender.forEach((stu) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${stu._id ?? ''}</td>
      <td>${escapeHtml(stu.name ?? '')}</td>
      <td>${escapeHtml(stu.courseName ?? stu.course ?? '')}</td>
      <td>${formatDate(stu.enrollmentDate)}</td>
      <td>
        <span class="status-badge status-${escapeHtml(stu.status ?? 'active')}">
          ${capitalizeFirstLetter(stu.status ?? 'active')}
        </span>
      </td>
      <td class="action-buttons">
        <button class="action-btn edit-btn" onclick="editStudent('${stu._id}')">
          <i class="fas fa-edit"></i> Edit
        </button>
        <button class="action-btn delete-btn" onclick="askDeleteStudent('${stu._id}')">
          <i class="fas fa-trash"></i> Delete
        </button>
      </td>`;
    tableBody.appendChild(row);
  });
}

function updateCourseDropdown(courseList) {
  const courseSelect = document.getElementById('course');
  if (!courseSelect) return;

  courseSelect.innerHTML = '<option value="">Select a course</option>';
  courseList
    .filter((c) => c.status === 'active')
    .forEach((c) => {
      const option = document.createElement('option');
      option.value = c._id;
      option.textContent = c.name;
      courseSelect.appendChild(option);
    });
}

function renderCourseTable(coursesToRender) {
  if (!courseTableBody) return;
  courseTableBody.innerHTML = '';

  if (!coursesToRender || coursesToRender.length === 0) {
    courseTableBody.innerHTML = `
      <tr>
        <td colspan="5" class="empty-state">
          <i class="fas fa-book"></i>
          <h3>No Courses Found</h3>
          <p>Click "Add Course" to add your first course</p>
        </td>
      </tr>`;
    return;
  }

  coursesToRender.forEach((course) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${course._id ?? ''}</td>
      <td>${escapeHtml(course.name ?? '')}</td>
      <td>${escapeHtml(course.description ?? '')}</td>
      <td>
        <span class="status-badge status-${escapeHtml(course.status ?? 'inactive')}">
          ${capitalizeFirstLetter(course.status ?? 'inactive')}
        </span>
      </td>
      <td class="action-buttons">
        <button class="action-btn edit-btn" onclick="editCourse('${course._id}')">
          <i class="fas fa-edit"></i> Edit
        </button>
        <button class="action-btn delete-btn" onclick="askDeleteCourse('${course._id}')">
          <i class="fas fa-trash"></i> Delete
        </button>
      </td>`;
    courseTableBody.appendChild(row);
  });
}

/* ====== Modals ====== */
function openStudentModal() {
  if (courses.length === 0) {
    showNotification('Please add at least one course before adding a student', 'warning');
    navigateToSection('courses');
    openCourseModal();
    return;
  }
  if (studentModel) studentModel.style.display = 'flex';
  editingId = null;
  studentForm?.reset();
  const title = document.getElementById('studentModelTitle');
  if (title) title.textContent = 'Add New Student';
}

function closeStudentModal() {
  if (studentModel) studentModel.style.display = 'none';
  editingId = null;
  studentForm?.reset();
}

function openCourseModal() {
  if (courseModel) courseModel.style.display = 'flex';
  editingCourseId = null;
  courseForm?.reset();
  const title = document.getElementById('courseModelTitle');
  if (title) title.textContent = 'Add New Course';
}

function closeCourseModal() {
  if (courseModel) courseModel.style.display = 'none';
  editingCourseId = null;
  courseForm?.reset();
}

/* ====== Edit Handlers ====== */
async function editStudent(id) {
  showLoading();
  try {
    const response = await fetch(`${API_BASE_URL}/api/students/${id}`);
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error.message || 'Failed to fetch student');
    }
    const student = await response.json();

    editingId = id;
    const title = document.getElementById('studentModelTitle');
    if (title) title.textContent = 'Edit Student';

    document.getElementById('studentName').value = student.name ?? '';
    document.getElementById('studentEmail').value = student.email ?? '';
    document.getElementById('course').value = student.course ?? '';
    document.getElementById('enrollmentDate').value = formatDateForInput(student.enrollmentDate);

    if (studentModel) studentModel.style.display = 'flex';
  } catch (error) {
    console.error('Error loading student for edit:', error);
    showNotification(error.message || 'Error loading student data', 'error');
  } finally {
    hideLoading();
  }
}

async function editCourse(id) {
  showLoading();
  try {
    const response = await fetch(`${API_BASE_URL}/api/courses/${id}`);
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error.message || 'Failed to fetch course');
    }
    const course = await response.json();

    editingCourseId = id;
    const title = document.getElementById('courseModelTitle');
    if (title) title.textContent = 'Edit Course';

    document.getElementById('courseName').value = course.name ?? '';
    document.getElementById('courseDescription').value = course.description ?? '';
    document.getElementById('courseDuration').value = course.duration ?? '';
    document.getElementById('courseStatus').value = course.status ?? 'inactive';

    if (courseModel) courseModel.style.display = 'flex';
  } catch (error) {
    console.error('Error loading course for edit:', error);
    showNotification(error.message || 'Error loading course data', 'error');
  } finally {
    hideLoading();
  }
}

/* ====== Search ====== */
let searchTimeout;
function handleSearch(e) {
  clearTimeout(searchTimeout);
  const searchTerm = e.target.value.trim();

  searchTimeout = setTimeout(async () => {
    if (searchTerm.length === 0) {
      await loadStudents();
      return;
    }
    showLoading();
    try {
      const response = await fetch(
        `${API_BASE_URL}/api/students/search?q=${encodeURIComponent(searchTerm)}`
      );
      if (!response.ok) throw new Error('Search failed');

      const filteredStudents = await response.json();
      renderStudentTables(filteredStudents);
    } catch (error) {
      console.error('Error searching students:', error);
      showNotification(error.message || 'Error searching students', 'error');
    } finally {
      hideLoading();
    }
  }, 300);
}

/* ====== Utility Functions ====== */
function showLoading() { loadingSpinner?.classList.add('active'); }
function hideLoading() { loadingSpinner?.classList.remove('active'); }

function formatDate(dateString) {
  if (!dateString) return '';
  const options = { year: 'numeric', month: 'short', day: 'numeric' };
  return new Date(dateString).toLocaleDateString(undefined, options);
}

function formatDateForInput(dateString) {
  if (!dateString) return '';
  const d = new Date(dateString);
  if (Number.isNaN(d.getTime())) return '';
  return d.toISOString().split('T')[0];
}

function capitalizeFirstLetter(str) {
  if (!str) return '';
  return str.charAt(0).toUpperCase() + str.slice(1);
}

function escapeHtml(str) {
  return String(str)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}

/* ====== Global Functions ====== */
window.openStudentModal = openStudentModal;
window.closeStudentModal = closeStudentModal;
window.openCourseModal = openCourseModal;
window.closeCourseModal = closeCourseModal;
window.editStudent = editStudent;
window.askDeleteStudent = askDeleteStudent;
window.editCourse = editCourse;
window.askDeleteCourse = askDeleteCourse;
window.confirmDelete = confirmDelete;
window.closeDeleteModal = closeDeleteModal;
    </script>
</body>
</html>